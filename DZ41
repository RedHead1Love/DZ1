using System;
using System.Collections.Generic;
using System.Linq;

namespace SupermarketAdministration
{
    class Program
    {
        static void Main(string[] args)
        {
            SupermarketManager manager = new SupermarketManager();
            manager.Run();
        }
    }

    public class SupermarketManager
    {
        private readonly Supermarket _supermarket;
        private readonly List<Product> _availableProducts;

        public SupermarketManager()
        {
            int _bread = 50;
            int _milk = 80;
            int _sugar = 60;
            int eggs = 120;
            int _butter = 150;


            _availableProducts = new List<Product>
            {
                new Product("Хлеб", _bread),
                new Product("Молоко", _milk),
                new Product("Яйца", eggs),
                new Product("Сахар", _sugar),
                new Product("Масло", _butter)
            };

            _supermarket = new Supermarket(_availableProducts);
        }    

        public void Run()
        {
            const string CommandMenuOptionShowProducts = "1";
            const string CommandMenuOptionAddClient = "2";
            const string CommandMenuOptionServeClient = "3";
            const string CommandMenuOptionShowEarnings = "4";
            const string CommandMenuOptionExit = "5";


            bool isRunning = true;

            while (isRunning)
            {
                Console.WriteLine("\nМеню управления супермаркетом:");
                Console.WriteLine($"{CommandMenuOptionShowProducts}. Показать список продуктов");
                Console.WriteLine($"{CommandMenuOptionAddClient}. Добавить клиента");
                Console.WriteLine($"{CommandMenuOptionServeClient}. Обслужить клиента");
                Console.WriteLine($"{CommandMenuOptionShowEarnings}. Показать доход");
                Console.WriteLine($"{CommandMenuOptionExit}. Выход из программы");

                Console.Write("Выберите действие: ");
                string choice = Console.ReadLine();

                switch (choice)
                {
                    case CommandMenuOptionShowProducts:
                        ShowProducts();
                        break;

                    case CommandMenuOptionAddClient:
                        AddClient();
                        break;

                    case CommandMenuOptionServeClient:
                        ServeClient();
                        break;

                    case CommandMenuOptionShowEarnings:
                        ShowEarnings();
                        break;

                    case CommandMenuOptionExit:
                        isRunning = false;
                        break;

                    default:
                        Console.WriteLine("Неверный выбор, попробуйте снова.");
                        break;
                }
            }
        }

        private void ShowProducts()
        {
            Console.WriteLine("\nДоступные товары:");

            for (int i = 0; i < _availableProducts.Count; i++)
            {
                Console.WriteLine($"{i + 1}. {_availableProducts[i].Name} - {_availableProducts[i].Price} руб.");
            }
        }

        private void AddClient()
        {
            Console.Write("Введите имя клиента: ");
            string name = Console.ReadLine();

            Console.Write("Введите количество денег у клиента: ");
            if (decimal.TryParse(Console.ReadLine(), out decimal money) == false)
            {
                Console.WriteLine("Некорректная сумма денег.");
                return;
            }

            var client = new Client(name, money);
            ManageClientShopping(client);

            _supermarket.AddClient(client);
            Console.WriteLine($"Клиент {name} добавлен в очередь.");
        }

        private void ManageClientShopping(Client client)
        {
            const string CommandAddProductToCart = "1";
            const string CommandFinishShopping = "2";
            const string CommandRemoveProductFromCart = "3";

            bool isShopping = true;

            while (isShopping)
            {
                Console.WriteLine($"\nТекущий баланс: {client.Money} руб.");
                Console.WriteLine("Товары в корзине:");

                ShowClientCart(client);

                Console.WriteLine("\nМеню покупок:");
                Console.WriteLine($"{CommandAddProductToCart}. Добавить товар в корзину");
                Console.WriteLine($"{CommandFinishShopping}. Удалить товар из корзины");
                Console.WriteLine($"{CommandRemoveProductFromCart}. Завершить покупки");

                Console.Write("Выберите действие: ");
                string choice = Console.ReadLine();

                switch (choice)
                {
                    case CommandAddProductToCart:
                        AddProductToClientCart(client);
                        break;

                    case CommandFinishShopping:
                        RemoveProductFromClientCart(client);
                        break;

                    case CommandRemoveProductFromCart:
                        isShopping = false;
                        break;

                    default:
                        Console.WriteLine("Неверный выбор, попробуйте снова.");
                        break;
                }
            }
        }

        private void ShowClientCart(Client client)
        {
            if (client.ShoppingCart.Count == 0)
            {
                Console.WriteLine("Корзина пуста");
                return;
            }

            for (int i = 0; i < client.ShoppingCart.Count; i++)
            {
                Console.WriteLine($"{i + 1}. {client.ShoppingCart[i].Name} - {client.ShoppingCart[i].Price} рублей");
            }
            Console.WriteLine($"Итого: {client.ShoppingCart.Sum(price => price.Price)} рублей");
        }

        private void AddProductToClientCart(Client client)
        {
            ShowProducts();
            Console.Write("Введите номер товара: ");

            if (int.TryParse(Console.ReadLine(), out int productNumber) == false ||
                productNumber < 1 || productNumber > _availableProducts.Count)
            {
                Console.WriteLine("Некорректный номер товара.");
                return;
            }

            var product = _availableProducts[productNumber - 1];
            client.AddToCart(product);

            Console.WriteLine($"Товар {product.Name} добавлен в корзину.");
        }

        private void RemoveProductFromClientCart(Client client)
        {
            if (client.ShoppingCart.Count == 0)
            {
                Console.WriteLine("Корзина пуста");
                return;
            }

            ShowClientCart(client);
            Console.Write("Введите номер товара для удаления: ");

            if (int.TryParse(Console.ReadLine(), out int productNumber) == false ||
                productNumber < 1 || productNumber > client.ShoppingCart.Count)
            {
                Console.WriteLine("Некорректный номер товара.");
                return;
            }

            var product = client.ShoppingCart[productNumber - 1];
            client.RemoveFromCart(productNumber - 1);

            Console.WriteLine($"Товар {product.Name} удален из корзины.");
        }

        private void ServeClient()
        {
            if (_supermarket.ClientsCount == 0)
            {
                Console.WriteLine("Нет клиентов в очереди.");
                return;
            }

            _supermarket.ServeNextClient();
            Console.WriteLine("Клиент обслужен.");
        }

        private void ShowEarnings()
        {
            Console.WriteLine($"\nОбщий доход: {_supermarket.EarnedMoney} руб.");
        }
    }

    public class Product
    {
        public string Name { get; }
        public decimal Price { get; }

        public Product(string name, decimal price)
        {
            Name = name;
            Price = price;
        }
    }

    public class Client
    {
        private readonly Random _random;
        private readonly string _name;
        private decimal _money;
        private readonly List<Product> _shoppingCart;
        private readonly List<Product> _shoppingBag;

        public string Name => _name;
        public decimal Money => _money;
        public IReadOnlyList<Product> ShoppingCart => _shoppingCart.AsReadOnly();
        public IReadOnlyList<Product> ShoppingBag => _shoppingBag.AsReadOnly();

        public Client(string name, decimal money)
        {
            _random = new Random();
            _name = name;
            _money = money;
            _shoppingCart = new List<Product>();
            _shoppingBag = new List<Product>();
        }

        public void AddToCart(Product product)
        {
            _shoppingCart.Add(product);
        }

        public void RemoveFromCart(int index)
        {
            if (index >= 0 && index < _shoppingCart.Count)
            {
                _shoppingCart.RemoveAt(index);
            }
        }

        public bool CanPay(decimal amount)
        {
            return _money >= amount;
        }

        public void RemoveRandomProductFromCart()
        {
            if (_shoppingCart.Count == 0)
                return;

            int index = _random.Next(_shoppingCart.Count);
            _shoppingCart.RemoveAt(index);
        }

        public void CompletePurchase(decimal amount)
        {
            if (CanPay(amount))
            {
                _money -= amount;
                _shoppingBag.AddRange(_shoppingCart);
                _shoppingCart.Clear();
            }
        }
    }

    public class Supermarket
    {
        private readonly List<Product> _products;
        private readonly Queue<Client> _clients;
        private decimal _earnedMoney;

        public IReadOnlyList<Product> Products => _products.AsReadOnly();
        public int ClientsCount => _clients.Count;
        public decimal EarnedMoney => _earnedMoney;

        public Supermarket(IEnumerable<Product> products)
        {
            _products = products.ToList();
            _clients = new Queue<Client>();
            _earnedMoney = 0;
        }

        public void AddClient(Client client)
        {
            if (client == null)
                throw new ArgumentNullException(nameof(client));

            _clients.Enqueue(client);
        }

        public void ServeNextClient()
        {
            if (_clients.Count == 0)
                return;

            Client currentClient = _clients.Dequeue();
            ProcessClientPurchase(currentClient);
        }

        private void ProcessClientPurchase(Client client)
        {
            decimal totalAmount = client.ShoppingCart.Sum(p => p.Price);

            while (!client.CanPay(totalAmount) && client.ShoppingCart.Count > 0)
            {
                Console.WriteLine($"У клиента {client.Name} недостаточно денег (нужно {totalAmount} руб., есть {client.Money} руб.)");
                Console.WriteLine("Удаляем случайный товар из корзины");

                client.RemoveRandomProductFromCart();
                totalAmount = client.ShoppingCart.Sum(p => p.Price);
            }

            if (client.ShoppingCart.Count > 0)
            {
                client.CompletePurchase(totalAmount);
                _earnedMoney += totalAmount;
                Console.WriteLine($"Клиент {client.Name} оплатил покупку на сумму {totalAmount} руб.");
            }
            else
            {
                Console.WriteLine($"Клиент {client.Name} не смог оплатить ни один товар.");
            }
        }
    }
}
